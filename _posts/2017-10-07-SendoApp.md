
# 2017 sendo data
Date, Unit, OrderSource, BuyerCity, Cat1.
Metrics:  Orders, GMV2


```python
from bokeh.io import output_notebook, output_file
from bokeh.plotting import show, figure 
from bokeh.models import HoverTool, ColumnDataSource, Jitter
from bokeh.models.widgets import Panel, Tabs
import numpy as np
import pandas as pd
from pandas.io import gbq
projectId = 'mindful-carport-156107'
output_notebook()
h = 350
w = 1200
startDate = '2017-03-01'
hash = {}
c = ('aliceblue', 'antiquewhite', 'aqua', 'aquamarine', 'azure', 'beige', 'bisque', 'black', 
    'blanchedalmond', 'blue', 'blueviolet', 'brown', 'burlywood', 'cadetblue', 'chartreuse', 
    'chocolate', 'coral', 'cornflowerblue', 'cornsilk', 'crimson', 'cyan', 'darkblue', 'darkcyan', 
    'darkgoldenrod', 'darkgray', 'darkgreen', 'darkgrey', 'darkkhaki', 'darkmagenta', 'darkolivegreen', 
    'darkorange', 'darkorchid', 'darkred', 'darksalmon', 'darkseagreen', 'darkslateblue', 'darkslategray', 
    'darkslategrey', 'darkturquoise', 'darkviolet', 'deeppink', 'deepskyblue', 'dimgray', 'dimgrey', 'dodgerblue', 
    'firebrick', 'floralwhite', 'forestgreen', 'fuchsia', 'gainsboro', 'ghostwhite', 'gold', 'goldenrod', 
    'gray', 'green', 'greenyellow', 'grey', 'honeydew', 'hotpink', 'indianred', 'indigo', 'ivory', 'khaki', 
    'lavender', 'lavenderblush', 'lawngreen', 'lemonchiffon', 'lightblue', 'lightcoral', 'lightcyan', 
    'lightgoldenrodyellow', 'lightgray', 'lightgreen', 'lightgrey', 'lightpink', 'lightsalmon', 'lightseagreen', 
    'lightskyblue', 'lightslategray', 'lightslategrey', 'lightsteelblue', 'lightyellow', 'lime', 'limegreen', 
    'linen', 'magenta', 'maroon', 'mediumaquamarine', 'mediumblue', 'mediumorchid', 'mediumpurple', 'mediumseagreen', 
    'mediumslateblue', 'mediumspringgreen', 'mediumturquoise', 'mediumvioletred', 'midnightblue', 'mintcream', 'mistyrose', 
    'moccasin', 'navajowhite', 'navy', 'oldlace', 'olive', 'olivedrab', 'orange', 'orangered', 'orchid', 'palegoldenrod', 
    'palegreen', 'paleturquoise', 'palevioletred', 'papayawhip', 'peachpuff', 'peru', 'pink', 'plum', 'powderblue', 
    'purple', 'red', 'rosybrown', 'royalblue', 'saddlebrown', 'salmon', 'sandybrown', 'seagreen', 'seashell', 'sienna', 
    'silver', 'skyblue', 'slateblue', 'slategray', 'slategrey', 'snow', 'springgreen', 'steelblue', 'tan', 'teal', 
    'thistle', 'tomato', 'turquoise', 'violet', 'wheat', 'white', 'whitesmoke', 'yellow', 'yellowgreen');
```



    <div class="bk-root">
        <a href="https://bokeh.pydata.org" target="_blank" class="bk-logo bk-logo-small bk-logo-notebook"></a>
        <span id="7e1bd69a-b74c-4961-bef5-7c6d36cd9d95">Loading BokehJS ...</span>
    </div>





```python
query = 'SELECT date, unit, cat1, orderSource, buyerCity, count(distinct orderId) as orders, sum(GMV2) as GMV2 FROM `mindful-carport-156107.\
cdaBISale.bi_sales2017` where phaHoai = "N" \
group by buyerCity,orderSource,unit, cat1, date  order by date desc'
df = gbq.read_gbq(query, projectId, dialect='standard')
df.date = pd.to_datetime(df.date)
# or
# import pandas as pd
# df = pd.read_csv('C:/Users/Khanh/OneDrive/SaleOrder/Request/cat1SourceCityOrderGMV.csv',encoding='utf8', low_memory=False)
df.head()
```

    Requesting query... ok.
    Job ID: job_vN8_P2RCN9-rJytf8Ss2GYsYrAq7
    Query running...
      Elapsed 12.75 s. Waiting...
      Elapsed 24.18 s. Waiting...
    Query done.
    Processed: 360.7 MB
    Standard price: $0.00 USD
    
    Retrieving results...
      Got page: 1; 5% done. Elapsed 39.11 s.
      Got page: 2; 11% done. Elapsed 47.06 s.
      Got page: 3; 16% done. Elapsed 53.77 s.
      Got page: 4; 22% done. Elapsed 61.5 s.
      Got page: 5; 27% done. Elapsed 69.34 s.
      Got page: 6; 32% done. Elapsed 77.69 s.
      Got page: 7; 38% done. Elapsed 85.34 s.
      Got page: 8; 43% done. Elapsed 93.29 s.
      Got page: 9; 49% done. Elapsed 101.1 s.
      Got page: 10; 54% done. Elapsed 108.67 s.
      Got page: 11; 59% done. Elapsed 114.58 s.
      Got page: 12; 65% done. Elapsed 122.71 s.
      Got page: 13; 70% done. Elapsed 131.71 s.
      Got page: 14; 75% done. Elapsed 139.06 s.
      Got page: 15; 81% done. Elapsed 146.99 s.
      Got page: 16; 86% done. Elapsed 155.06 s.
      Got page: 17; 92% done. Elapsed 162.68 s.
      Got page: 18; 97% done. Elapsed 170.52 s.
      Got page: 19; 100% done. Elapsed 177.12 s.
    Got 927296 rows.
    
    Total time taken 204.12 s.
    Finished at 2017-10-07 13:13:29.
    


```python
dfTT = df[(df['unit']=='TTTT') & (df.date >= startDate)].groupby(['date','orderSource']).agg({'orders':np.sum, 'GMV2': np.sum}).reset_index(level=[0,1])
dfDT = df[(df['unit']=='TTDT') & (df.date >= startDate)].groupby(['date','orderSource']).agg({'orders':np.sum, 'GMV2': np.sum}).reset_index(level=[0,1])

#loop through and assign colors:
counter = 15
for a in dfTT.orderSource.unique():
    hash[a] = c[counter]
    counter += 1
# generate colors:
colors = [hash[code] for code in dfTT.orderSource]
dfTT['color'] = colors
colors = [hash[code] for code in dfTT.orderSource]
dfDT['color'] = colors

# Top1: Thoi trang orders
source = ColumnDataSource(dfTT)
t1 = figure(height =h, width=w, x_axis_type='datetime', output_backend="webgl", title = 'Trung tâm thời trang',\
           x_axis_label= 'orders')
# t1.scatter(x = dfTT.date, y= dfTT.orders, fill_color=dfTT.orderSource, size = 10, alpha = 0.1)
t1.scatter('date', 'orders', fill_color='color', size = 10, alpha = 0.7, source = source )
hover = HoverTool(tooltips=[
    ("Index","$index"),
    ("Date","@date{%F}"),
    ("Orders","@orders"),      
    ("Source","@orderSource"),  
],
    formatters = {"date":"datetime"}, 
#     mode='vline'
                 )
t1.add_tools(hover)
tab1t = Panel(child = t1, title='Orders PC1')

# Top2 Thoi trang GMV
t2 = figure(height =h, width=w, x_axis_type='datetime', output_backend="webgl", title = 'Trung tâm thời trang',\
           x_axis_label= 'GMV')
t2.scatter('date', 'GMV2', fill_color='color', size = 10, alpha = 0.7, source = source )
hover = HoverTool(tooltips=[
    ("Index","$index"),
    ("Date","@date{%F}"),
    ("GMV2","@GMV2"),      
    ("Source","@orderSource"),  
],
    formatters = {"date":"datetime"}, 
#     mode='vline'
                 )
t2.add_tools(hover)
tab2t = Panel(child = t2, title='GMV PC1')

# Bottom1: Dien tu orders
source = ColumnDataSource(dfDT)
b1 = figure(height =h, width=w, x_axis_type='datetime', output_backend="webgl", title = 'Trung tâm điện tử ',\
           x_axis_label= 'orders')
b1.scatter('date', 'orders', fill_color='color', size = 10, alpha = 0.7, source = source )
hover = HoverTool(tooltips=[
    ("Index","$index"),
    ("Date","@date{%F}"),
    ("Orders","@orders"),      
    ("Source","@orderSource"),  
],
    formatters = {"date":"datetime"}, 
#     mode='vline'
                 )
b1.add_tools(hover)
tab1b = Panel(child = b1, title='Orders PC2')

# GMV PC2
b2 = figure(height =h, width=w, x_axis_type='datetime', output_backend="webgl", title = 'Trung tâm điện tử',\
           x_axis_label= 'GMV')
b2.scatter('date', 'GMV2', fill_color='color', size = 10, alpha = 0.7, source = source )
hover = HoverTool(tooltips=[
    ("Index","$index"),
    ("Date","@date{%F}"),
    ("GMV","@GMV2"),      
    ("Source","@orderSource"),  
],
    formatters = {"date":"datetime"}, 
#     mode='vline'
                 )
b2.add_tools(hover)
tab2b = Panel(child = b2, title='GMV PC2')

# Split into Big (HCM - HN) and Small cities
dfBigCitiesTT = df[(df.buyerCity.isin(['Hồ Chí Minh','Hà Nội'])) & (df.unit.isin(['TTTT'])) & (df.date >= startDate)].groupby(['date','orderSource']).agg({'orders':np.sum, 'GMV2': np.sum}).reset_index(level=[0,1])
dfSmallCitiesTT = df[(~df.buyerCity.isin(['Hồ Chí Minh','Hà Nội'])) & (df.unit.isin(['TTTT'])) & (df.date >= startDate)].groupby(['date','orderSource']).agg({'orders':np.sum, 'GMV2': np.sum}).reset_index(level=[0,1])
dfBigCitiesDT = df[(df.buyerCity.isin(['Hồ Chí Minh','Hà Nội'])) & (df.unit.isin(['TTDT'])) & (df.date >= startDate)].groupby(['date','orderSource']).agg({'orders':np.sum, 'GMV2': np.sum}).reset_index(level=[0,1])
dfSmallCitiesDT = df[(~df.buyerCity.isin(['Hồ Chí Minh','Hà Nội'])) & (df.unit.isin(['TTDT'])) & (df.date >= startDate)].groupby(['date','orderSource']).agg({'orders':np.sum, 'GMV2': np.sum}).reset_index(level=[0,1])

#loop through and assign colors:
counter = 15
for a in dfTT.orderSource.unique():
    hash[a] = c[counter]
    counter += 1
# generate colors:
colors = [hash[code] for code in dfBigCitiesTT.orderSource]
dfBigCitiesTT['color'] = colors
colors = [hash[code] for code in dfSmallCitiesTT.orderSource]
dfSmallCitiesTT['color'] = colors
colors = [hash[code] for code in dfBigCitiesDT.orderSource]
dfBigCitiesDT['color'] = colors
colors = [hash[code] for code in dfSmallCitiesDT.orderSource]
dfSmallCitiesDT['color'] = colors

#Top3: Big cities Thoi trang orders
source = ColumnDataSource(dfBigCitiesTT)
t3 = figure(height =h, width=w, x_axis_type='datetime', output_backend="webgl", title = 'Trung tâm thời trang',\
           x_axis_label= 'orders')
t3.scatter('date', 'orders', fill_color='color', size = 10, alpha = 0.7, source = source )
hover = HoverTool(tooltips=[
    ("Index","$index"),
    ("Date","@date{%F}"),
    ("Orders","@orders"),      
    ("Source","@orderSource"),  
],
    formatters = {"date":"datetime"}, 
#     mode='vline'
                 )
t3.add_tools(hover)
tab3t = Panel(child = t3, title='Orders PC1 HCM HN')

# Top4: Small cities Thoi trang orders
source = ColumnDataSource(dfSmallCitiesTT)
t4 = figure(height =h, width=w, x_axis_type='datetime', output_backend="webgl", title = 'Trung tâm thời trang',\
           x_axis_label= 'GMV')
t4.scatter('date', 'GMV2', fill_color='color', size = 10, alpha = 0.7, source = source )
hover = HoverTool(tooltips=[
    ("Index","$index"),
    ("Date","@date{%F}"),
    ("GMV","@GMV2"),      
    ("Source","@orderSource"),  
],
    formatters = {"date":"datetime"}, 
#     mode='vline'
                 )
t4.add_tools(hover)
tab4t = Panel(child = t4, title='GMV PC1 Tỉnh')

# Bottom3: Orders PC2 HCM HN
source = ColumnDataSource(dfBigCitiesDT)
b3 = figure(height =h, width=w, x_axis_type='datetime', output_backend="webgl", title = 'Trung tâm thời trang',\
           x_axis_label= 'orders')
b3.scatter('date', 'orders', fill_color='color', size = 10, alpha = 0.7, source = source )
hover = HoverTool(tooltips=[
    ("Index","$index"),
    ("Date","@date{%F}"),
    ("Orders","@orders"),      
    ("Source","@orderSource"),  
],
    formatters = {"date":"datetime"}, 
#     mode='vline'
                 )
b3.add_tools(hover)
tab3b = Panel(child = b3, title='Orders PC2 HCM HN')

#Bottom 4: GMV PC2 Tỉnh
source = ColumnDataSource(dfSmallCitiesDT)
b4 = figure(height =h, width=w, x_axis_type='datetime', output_backend="webgl", title = 'Trung tâm thời trang',\
           x_axis_label= 'GMV')
b4.scatter('date', 'orders', fill_color='color', size = 10, alpha = 0.7, source = source )
hover = HoverTool(tooltips=[
    ("Index","$index"),
    ("Date","@date{%F}"),
    ("GMV","@GMV2"),      
    ("Source","@orderSource"),  
],
    formatters = {"date":"datetime"}, 
#     mode='vline'
                 )
b4.add_tools(hover)
tab4b = Panel(child = b4, title='GMV PC2 Tỉnh')


#Top 5: ototxemay orders
# generate colors:
colors = [hash[code] for code in dfOtoxemay.orderSource]
dfOtoxemay['color'] = colors
#generte data source
source = ColumnDataSource(dfOtoxemay)

t5 = figure(height = h, width = w, x_axis_type='datetime', output_backend="webgl", title = 'O to xe may',x_axis_label= 'Orders')
t5.scatter('date', 'orders', fill_color='color', size = 10, alpha = 0.7, source = source )
hover = HoverTool(tooltips=[
    ("Index","$index"),
    ("Date","@date{%F}"),
    ("Orders","@orders"),      
    ("Source","@orderSource"),  
],
    formatters = {"date":"datetime"}, 
#     mode='vline'
                 )
t5.add_tools(hover)
# show(t5)
tab5t = Panel(child = t5, title='Orders o-to-xe-may')

# Top 6: toàn sàn orders theo cat1
dfCat1 = df[(df.date >= startDate) & (df.date != '2017-04-09')].groupby(['date','cat1']).agg({'orders':np.sum, 'GMV2': np.sum}).reset_index(level=[0,1])
#loop through and assign colors:
counter = 15
for a in dfCat1.cat1.unique():
    hash[a] = c[counter]
    counter += 1

# generate colors:
colors = [hash[code] for code in dfCat1.cat1]
dfCat1['color'] = colors
source = ColumnDataSource(dfCat1)
t6 = figure(height =h, width=w, x_axis_type='datetime', output_backend="webgl", title = '2 trung tâm',\
           x_axis_label= 'Orders')
# p7.scatter(x = dfDummy.date, y= dfDummy.orders, fill_color=colors, size = 10, alpha = 0.5 )
t6.scatter('date', 'orders', fill_color='color', size = 10, alpha = 0.7, source = source )
hover = HoverTool(tooltips=[
    ("Index","$index"),
    ("Date","@date{%F}"),
    ("Orders","@orders"),      
    ("Cat1","@cat1"),  
],
    formatters = {"date":"datetime"}, 
#     mode='vline'
                 )
t6.add_tools(hover)
# show(t6)
tab6t = Panel(child = t6, title='Orders toàn sàn cat1')
```


```python
tabsTT = Tabs(tabs=[tab1t, tab2t, tab3t, tab4t, tab5t, tab6t])
show(tabsTT)
tabsDT = Tabs(tabs=[tab1b,tab2b, tab3b, tab4b])
show(tabsDT)
```



<div class="bk-root">
    <div class="bk-plotdiv" id="0af53be8-1827-41bf-8fca-e3256a49ecff"></div>
</div>






<div class="bk-root">
    <div class="bk-plotdiv" id="fa98cc7e-3a96-405a-9044-4093b5bad10d"></div>
</div>



